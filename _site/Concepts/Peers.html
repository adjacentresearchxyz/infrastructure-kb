<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Peers | Adjacent</title> <meta name="generator" content="Jekyll v4.3.2" /> <meta property="og:title" content="Peers" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A Knowledge base for operating infrastructure for validators, keepers, etc." /> <meta property="og:description" content="A Knowledge base for operating infrastructure for validators, keepers, etc." /> <link rel="canonical" href="http://localhost:4000/Concepts/Peers.html" /> <meta property="og:url" content="http://localhost:4000/Concepts/Peers.html" /> <meta property="og:site_name" content="Adjacent" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Peers" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A Knowledge base for operating infrastructure for validators, keepers, etc.","headline":"Peers","url":"http://localhost:4000/Concepts/Peers.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Adjacent </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Concepts category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/Concepts/" class="nav-list-link">Concepts</a><ul class="nav-list"><li class="nav-list-item "><a href="/Concepts/Business.html" class="nav-list-link">Business</a></li><li class="nav-list-item "><a href="/Concepts/Business%20Continuity.html" class="nav-list-link">Business Continuity</a></li><li class="nav-list-item "><a href="/Concepts/Building.html" class="nav-list-link">Cosmos Tools</a></li><li class="nav-list-item "><a href="/Concepts/HSM.html" class="nav-list-link">HSM for Signing</a></li><li class="nav-list-item "><a href="/Concepts/Validator%20High%20Availability.html" class="nav-list-link">High Availability</a></li><li class="nav-list-item "><a href="/Concepts/Key%20Management.html" class="nav-list-link">Key Management</a></li><li class="nav-list-item "><a href="/Concepts/Linux%20Config.html" class="nav-list-link">Linux Configuration</a></li><li class="nav-list-item "><a href="/Concepts/Monitoring.html" class="nav-list-link">Monitoring</a></li><li class="nav-list-item active"><a href="/Concepts/Peers.html" class="nav-list-link active">Peers</a></li><li class="nav-list-item "><a href="/Concepts/Security%20Engineering.html" class="nav-list-link">Security Engineering</a></li><li class="nav-list-item "><a href="/Concepts/Systems%20Design.html" class="nav-list-link">Systems Design</a></li><li class="nav-list-item "><a href="/Concepts/Testing.html" class="nav-list-link">Testing</a></li><li class="nav-list-item "><a href="/Concepts/Validator%20Operations%20Guide.html" class="nav-list-link">Validator Operations</a></li><li class="nav-list-item "><a href="/Concepts/Values.html" class="nav-list-link">Values</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Nodes category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/Nodes/" class="nav-list-link">Nodes</a><ul class="nav-list"><li class="nav-list-item "><a href="/Nodes/cl/nodes.html" class="nav-list-link">Consensus Layer Nodes</a></li><li class="nav-list-item "><a href="/Nodes/cl/provisioning.html" class="nav-list-link">Consensus Layer Provisioning</a></li><li class="nav-list-item "><a href="/Nodes/el/nodes.html" class="nav-list-link">Execution Layer Nodes</a></li><li class="nav-list-item "><a href="/Nodes/el/provisioning.html" class="nav-list-link">Execution Provisioing</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Tools and Resources category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/Tools/" class="nav-list-link">Tools and Resources</a><ul class="nav-list"><li class="nav-list-item "><a href="/Tools/CoreOS%2038d7c619ca894417aa08c624154e4f05.html" class="nav-list-link">CoreOS</a></li><li class="nav-list-item "><a href="/Tools/Grafana%2077a16aee0ed046b2a0d38896117bae4f.html" class="nav-list-link">Grafana</a></li><li class="nav-list-item "><a href="/Tools/Nix%207784f9d6cc4e4d22b641606d10105fc4.html" class="nav-list-link">Nix</a></li><li class="nav-list-item "><a href="/Tools/Systemd%2052d24727df354933a92435c35b657813.html" class="nav-list-link">Systemd</a></li><li class="nav-list-item "><a href="/Tools/Tailscale%20db8b7f2df4aa4d2e81cf9137b3ea7dfe.html" class="nav-list-link">Tailscale</a></li><li class="nav-list-item "><a href="/Tools/Blog%20Posts.html" class="nav-list-link">Technical Knowledge Blogs</a></li><li class="nav-list-item "><a href="/Tools/Terraform%205bdc9ddd7b2342e6b67b83d866006fd6.html" class="nav-list-link">Terraform</a></li><li class="nav-list-item "><a href="/Tools/Vault%20fd5dd827a9de4245937760f75b9a6baa.html" class="nav-list-link">Vault</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Adjacent" aria-label="Search Adjacent" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://adjacentresearch.xyz" class="site-button" > Adjacent </a> </li> <li class="aux-nav-list-item"> <a href="https://twitter.com/adjacentresearchxyz" class="site-button" > Twitter </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/Concepts/">Concepts</a></li> <li class="breadcrumb-nav-list-item"><span>Peers</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="tendermint-p2p-layer"> <a href="#tendermint-p2p-layer" class="anchor-heading" aria-labelledby="tendermint-p2p-layer"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Tendermint P2P Layer<a href="#tendermint-p2p-layer" title="Permalink to this headline"></a> </h1> <p>This article explains the Tendermint P2P Layer and many of its gotchas. Understanding the P2P Layer has been very important to us, since it has important systems architecture implications.</p> <h2 id="intro"> <a href="#intro" class="anchor-heading" aria-labelledby="intro"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Intro<a href="#intro" title="Permalink to this headline"></a> </h2> <p>The Tendermint P2P implementation is based on a relatively simple concept.</p> <h3 id="types-of-peers"> <a href="#types-of-peers" class="anchor-heading" aria-labelledby="types-of-peers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Types of peers<a href="#types-of-peers" title="Permalink to this headline"></a> </h3> <p>Each node in the network is configured to dial a set of <code class="language-plaintext highlighter-rouge">seed</code> and <code class="language-plaintext highlighter-rouge">persistentPeers</code> when it is first started. Both of these parameters can be set in the config.</p> <p><strong>Persistent peers</strong></p> <p>The Tendermint node will try to maintain a permanent connection with this peer during its runtime. That also means that it will persistently try to redial the node if the connection fails. This is for example useful for the connection between Validator and Sentry nodes, because they will immediately try to reconnect after a connection failure, and there is no scenario where they could be stuck in a unreasonably long backoff or generally be removed from the peers addressbook which could cause unforeseen issues in a Sentry architecture.</p> <p><strong>Seeds</strong></p> <p>Seed nodes are only there to provide an up-to-date list of peers of the network. If a node is configured to run as a seed node, it will actively search the network for new peers and store them in its addressbook. However, it will not maintain active connections with the peers it queries. Connections from a seed node are meant to be short-lived in order to just query the other peers addressbook, learn about its new peers and then disconnect again. If you specify a seed node in the config of your node it will try to dial it on startup to retrieve an up-to-date addressbook as well as a list of peers on the network to bootstrap its connections.</p> <h3 id="addressbook"> <a href="#addressbook" class="anchor-heading" aria-labelledby="addressbook"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Addressbook<a href="#addressbook" title="Permalink to this headline"></a> </h3> <p>From the moment the node has acquired a list of peers on the network it will store them in a weighted <em>addressbook</em>.</p> <p>This addressbook stores all peers the client has ever learned about (and possibly connected to). When a connection to a peer fails, this is marked in the addressbook and will lead to a backoff before the next reconnection attempt is made. If a peer connection fails for more than <em>x</em> times (where <em>x</em> is a constant hardcoded in Tendermint at the moment), the peer is marked as bad and removed from the addressbook.</p> <h3 id="connection-types"> <a href="#connection-types" class="anchor-heading" aria-labelledby="connection-types"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Connection Types<a href="#connection-types" title="Permalink to this headline"></a> </h3> <p><strong>Inbound connection</strong></p> <p>Every connection that was initiated by another peer which contacted our node from the outside is called an inbound connection. The number of maximum inbound connections can be specified with <code class="language-plaintext highlighter-rouge">max_num_inbound_peers</code>. In order for another peer to create a connection to our node our P2P port (26656 by default) has to be publicly exposed.</p> <p><strong>Outbound connection</strong></p> <p>Every connection that was initiated by our peer (because of persistent peers, manual dialing or the PEX reactor) is an outbound connection. In order to establish an outbound connection the P2P port does not have to be opened as long as outbound connections are allowed by firewall rules.</p> <h2 id="the-peer-reactor"> <a href="#the-peer-reactor" class="anchor-heading" aria-labelledby="the-peer-reactor"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The peer reactor<a href="#the-peer-reactor" title="Permalink to this headline"></a> </h2> <p>Depending on whether you have a normal or seed node, the PEX (peer exchange) reactor will execute the following loop regularly.</p> <h3 id="normal-peer"> <a href="#normal-peer" class="anchor-heading" aria-labelledby="normal-peer"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Normal peer<a href="#normal-peer" title="Permalink to this headline"></a> </h3> <h4 id="startup"> <a href="#startup" class="anchor-heading" aria-labelledby="startup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Startup<a href="#startup" title="Permalink to this headline"></a> </h4> <p>The node will check its addressbook for valid peers to connect to and connect to all of the persistent peers specified. If the addressbook is empty, it will try to connect to one of the specified seed nodes.</p> <h4 id="loop"> <a href="#loop" class="anchor-heading" aria-labelledby="loop"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Loop<a href="#loop" title="Permalink to this headline"></a> </h4> <p>In the peer exchange routine the node will try to connect to new nodes from its addressbook until it has reached the <code class="language-plaintext highlighter-rouge">max_num_outbound_peers</code> (as of tendermint commit <a href="https://github.com/tendermint/tendermint/commit/6fad8eaf5a7d82000c3f2933ec61e0f3917d07cf">6fad8eaf5</a>).</p> <p>It will also query a random peer for its addressbook if the addressbook of itself is not yet “full” (currently 1000 entries).</p> <h3 id="seed-node"> <a href="#seed-node" class="anchor-heading" aria-labelledby="seed-node"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Seed node<a href="#seed-node" title="Permalink to this headline"></a> </h3> <h4 id="startup-1"> <a href="#startup-1" class="anchor-heading" aria-labelledby="startup-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Startup<a href="#id1" title="Permalink to this headline"></a> </h4> <p><em>as with a normal node</em></p> <h4 id="loop-1"> <a href="#loop-1" class="anchor-heading" aria-labelledby="loop-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Loop<a href="#id2" title="Permalink to this headline"></a> </h4> <p>The node will try to clean up its connections by closing every connection that has been found to be healthy.</p> <p>Then, it will attempt to connect to all its known peers from the addressbook and ask them for their addressbook.</p> <p>This behaviour intends to get a picture of the network that contains almost every public node available in order to allow new nodes to easily bootstrap using an up-to-date addressbook.</p> <h2 id="operation-notes"> <a href="#operation-notes" class="anchor-heading" aria-labelledby="operation-notes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Operation Notes<a href="#operation-notes" title="Permalink to this headline"></a> </h2> <p>Knowing all of this, there are a number of different ways to improve your network’s resilience by taking advantage of how the P2P reactor works.</p> <h3 id="running-outbound-only-nodes"> <a href="#running-outbound-only-nodes" class="anchor-heading" aria-labelledby="running-outbound-only-nodes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running outbound only nodes<a href="#running-outbound-only-nodes" title="Permalink to this headline"></a> </h3> <p>In order to reduce your DDoS attack surface you might want to run outbound only sentry nodes.</p> <p>Outbound only nodes behind a stateful firewall - that is, any firewall that isn’t a simple router ACL - allow you to completely drop incoming connections, permitting only packets belonging to existing sessions. That way, your node is not publicly reachable from the internet except for the TCP sessions that you have established with your peers. This greatly reduces the attack surface for network-layer attacks. Depending on your peer selection policy, it can also reduce the attack surface for L7 (application layer) attacks by only connecting to trusted nodes.</p> <p>With global TCP load balancers like Google Cloud and CloudFlare Spectrum, the stateful firewall is moved closer to the providers edge points of presence (PoPs), allowing you to absorb large denial-of-service attacks (the provider will drop unknown packets right when they enter their network, distributing attack traffic across their PoPs rather than congesting the single availability zone your application is running in).</p> <p>Additional safety measures could be to announce a wrong IP using PEX, which confuses nodes other than those those you are connecting to. That way, only the peers you have established connections with will know your true IP.</p> <p>However, this also increases the importance of having uncompromised peers because other peers of potentially good actors on the network won’t be able to connect to you and if your maximum number of outbound peers is filled with compromised peers, you will only see these nodes and no others as we have learned above. Such a compromise may allow an attacker to alter your view of the network, rendering you unable to catch up with the network or even cause your node to exhibit byzantine behaviour, if it’s in a vulnerable state.</p> <p>So it’s very important to (either):</p> <ul> <li>Set a high number of outgoing peers</li> <li>Add at least some trusted persistent peers</li> <li>Implement additional measures to either select peers or rotate peers on a regular basis</li> </ul> <p>Warning</p> <p>If your firewall is misconfigured or you are announcing a wrong public IP (e.g. your internal Docker IP) your node will be <em>outbound-only</em> unintentionally since no other nodes can connect from the outside (assuming you are not configured as persistent peer using your true IP). This can result in slow syncing and missed blocks due to delays in consensus message gossip, unless you apply the optimizations noted above.</p> <p>Note</p> <p>Outbound-only peers are meant as an additional measure to protect your validator from DDoS and similar attacks. However, running only outbound peers can cause network partitioning, slow bootstrapping for new network participants and general network destabilization. Plase make sure that you run only a small portion of your sentries in an outbound-only configuration to ensure the overall quality of the network.</p> <h3 id="running-full-duplex-nodes"> <a href="#running-full-duplex-nodes" class="anchor-heading" aria-labelledby="running-full-duplex-nodes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running “full-duplex” nodes<a href="#running-full-duplex-nodes" title="Permalink to this headline"></a> </h3> <p>Full-Duplex or inbound/outbound nodes are the default configuration for nodes. They allow both inbound connections to be established from the outside as well as outbound connections.</p> <p>In order to run a full-duplex node your firewall needs to be opened for both in- and outbound traffic on the relevant port (26656 by default).</p> <p>Since the host can be reached from the public internet, the risk for DDoS is higher. However, this configuration allows new peers to establish connections with them and thereby increases the overall network’s resilience.</p> <p>You should run most of your sentries as “full-duplex” nodes.</p> <p>Please keep in mind to set your number of maximum inbound peers in the config file to an appropriate value to get a better view of the network.</p> <h3 id="private-nodes"> <a href="#private-nodes" class="anchor-heading" aria-labelledby="private-nodes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Private nodes<a href="#private-nodes" title="Permalink to this headline"></a> </h3> <p>Private nodes communicate via VPN or other private networks and allow only selected peers to establish connections with them. Such a configuration could be used for validator-validator private peerings.</p> <p>In order to not leak any information about the node, it can be run with PEX disabled and the peering with the other nodes hardcoded as <em>persistent peer</em>.</p> <h2 id="the-sentry-architecture"> <a href="#the-sentry-architecture" class="anchor-heading" aria-labelledby="the-sentry-architecture"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Sentry architecture<a href="#the-sentry-architecture" title="Permalink to this headline"></a> </h2> <p>In order to deploy multiple different kinds of nodes, as described above, in our network and combine their strengths we need an additional layer besides our single validator node (or multiple validator nodes).</p> <p>In order to effectively mitigate DDoS attacks we also don’t want to publicly expose our validator nodes (IPs) to the internet.</p> <p>This is implemented in an architecture developed by the Tendermint/Cosmos team called <em>Sentry node architecture</em>.</p> <p>While the validators reside in a Virtual Private Network (like it’s e.g. offered by many cloud providers) or actual private network that is disconnected from the internet our Sentries basically build a <em>proxy</em> layer between this network and the public internet / cosmos network.</p> <p><em>Sentry</em> nodes are full cosmos nodes whose only task it is to relay messages and blocks to the validator nodes.</p> <p>This is done by assigning the Sentry nodes both a public and private interface and hardcoding the validator nodes as persistent peers. The PEX reactor is limited in a way to not broadcast the validator nodes to the other public peers in the network.</p> <p>As a result no network participant will ever have a direct connection with one of our validator nodes and will therefore also not be able to DDoS these directly. The Sentry nodes form a shielding layer and are not limited in their number since they only act as a proxy and have no special <em>stateful</em> task like signing. New nodes can be added and removed at any time as long as a minimum amount is kept online.</p> <p>To learn more about the Sentry architecture and how to configure your nodes accordingly look at the <a href="https://cosmos.network/docs/validators/security.html#sentry-nodes-ddos-protection">Cosmos Docs</a>.</p> <h2 id="sentry-auto-scaling"> <a href="#sentry-auto-scaling" class="anchor-heading" aria-labelledby="sentry-auto-scaling"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Sentry-Auto-Scaling<a href="#sentry-auto-scaling" title="Permalink to this headline"></a> </h2> <p><em>Actually</em>… Sentry Auto Scaling isn’t the best way to protect yourself against DDoS attacks, and Certus One is investing in proper DDoS protection rather than sentry scale-out.</p> <p>Autoscaling is a common and successful defense against application-layer DDoS in webservers and APIs - you just outnumber the attacker by responding to every single of their requests.</p> <p>It might seem obvious to apply the same approach to sentry nodes, however, it’s less effective and more expensive than you might expect.</p> <p>Let’s first take a look at potential DDoS vectors of your validator:</p> <p><strong>L7 - Application Layer</strong>:</p> <p>Vulnerabilities in Tendermint or the Cosmos SDK can allow an attacker to slow or take your nodes down with little effort and bandwidth. Traditional DDoS solutions will mostly not be able to mitigate this since they lack protocol-level insight.</p> <p><strong>L4 - Protocol Layer</strong>:</p> <p>SYN floods and similar attacks which aim to overwhelm your load balancer or operating system or fill up its flow tracking tables.</p> <p><strong>L2/3 - Network Layer</strong></p> <p>Large-scale high-bandwidth reflection attacks which aim to saturate the network interface of your hosts, or provider, or even your provider’s provider (it happens).</p> <p>Now, how does autoscaling mitigate these?</p> <p><strong>L7 attacks</strong> cannot be mitigated by creating more nodes. Since there are no high bandwidth requirements on the attacker side, they can just continue attacking each new node, taking it down as well which would trigger the creation of more new nodes in an auto-scaling environment. It’s not much of a difference to them whether they need to attack 100 or 200 nodes, but it makes a huge difference to you. It won’t get you anywhere, but will get really expensive, really fast (which might be all the attacker wants, anyway).</p> <p>To prevent this, one would need sophisticated auto-scaling algorithms which stops scaling up if new nodes quickly stop responding.</p> <p>So what about <strong>L2/3/4 attacks</strong>?</p> <p>If your sentry nodes are getting attacked by large amplification attacks (which are easily in the &gt;100 Gpbs range), they will be down immediately - all it takes is 1-2 Gbits. Your provider is probably going to nullroute your IP, preventing the attacker from taking down the provider’s network, sacrificing your IP for the greater good. On the other hand, if your provider is experienced in mitigating DDoS attacks and has sufficient bandwidth, he will easily be able to mitigate the attacks. They are straight-forward to filter (fixed source port).</p> <p>The same goes for SYN floods - they either kill your node right away, or are easily defeated or rate limited to insignificance by a competent provider or even a cloud provider’s TCP proxy (see above - GCP and CloudFlare can both proxy TCP connections).</p> <p>Auto scaling of sentries <em>can</em> help with volumetric attacks, as you would just spawn more sentries until the attacker no longer has sufficient capacities to attack all of them.</p> <p>The issue is that this requires a lot of resources on your side. Spawning up nodes to match the bandwidth of the attacker can be quite expensive, especially over longer periods of time. While you might remain online during the attack, the attacker is still having the financial upper hand and could potentially blackmail you (he’s not paying for the compromised servers he’s using!).</p> <p>In order to quickly scale up Cosmos nodes you need to have snapshots of the blockchain data in place because it would otherwise take very long for it to sync with the network. That is another point of failure in case of such an attack especially considering the growing size of the blockchain and the extra infrastructure you need. Additionally, even with recent snapshots, it will take a while for you new node to catch up.</p> <p>What else to do?</p> <p>One of the very obvious alternatives and additional security measures is <strong>outbound-only nodes</strong> as described above, in combination with a global TCP proxy like GCP’s global LB or CloudFlare Spectrum. These can handle bandwidths in excess of most realistic DDoS attacks, without any of the traffic reaching your sentry node. Additionally, chances are that your attacker do not even know the IP address of the node since it only initiates a limited amount of outbound connections. This can even be stripped down to a selected set of peers to further increase security which ultimately leads us to <em>private peers</em>.</p> <p>With <strong>private peers</strong> in place, you have got nodes that are not publicly known and in the best case (with potential direct <em>in-cloud peerings</em> or private network interconnects) expose almost no external attack surface. An attacker would have to take down all of the other validators you peer with to prevent them from relaying your messages.</p> <p>This eliminates most of the DDoS threat - an attacker would have to overwhelm Google’s TCP proxy or CloudFlare spectrum as well as all of your private peers. If he even misses a single node, your validator will still be functional.</p> <p>We recommend you invest your time into advanced DDoS mitigation setups, good relationships with other validators and a diverse set of sentries running at different providers rather than building a less effective, but complex cloud autoscaling mechanism.</p> <hr> <footer> <div class="d-flex mt-2"> <p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/adjacentresearchxyz/infrastructure-kb/tree/main/Concepts/Peers.md" id="edit-this-page">Edit this page on GitHub.</a> </p> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
