<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Systems Design | Infrastructure Knowledge Base</title> <meta name="generator" content="Jekyll v4.3.2" /> <meta property="og:title" content="Systems Design" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A Knowledge base for operating infrastructure for validators, keepers, etc." /> <meta property="og:description" content="A Knowledge base for operating infrastructure for validators, keepers, etc." /> <link rel="canonical" href="http://localhost:4000/Concepts/Systems%20Design.html" /> <meta property="og:url" content="http://localhost:4000/Concepts/Systems%20Design.html" /> <meta property="og:site_name" content="Infrastructure Knowledge Base" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Systems Design" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A Knowledge base for operating infrastructure for validators, keepers, etc.","headline":"Systems Design","url":"http://localhost:4000/Concepts/Systems%20Design.html"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Infrastructure Knowledge Base </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/Concepts/Business.html" class="nav-list-link">Business</a></li><li class="nav-list-item"><a href="/Concepts/Business%20Continuity.html" class="nav-list-link">Business Continuity</a></li><li class="nav-list-item"><a href="/Nodes/cl/nodes.html" class="nav-list-link">Consensus Layer Nodes</a></li><li class="nav-list-item"><a href="/Nodes/cl/provisioning.html" class="nav-list-link">Consensus Layer Provisioning</a></li><li class="nav-list-item"><a href="/Tools/CoreOS%2038d7c619ca894417aa08c624154e4f05.html" class="nav-list-link">CoreOS</a></li><li class="nav-list-item"><a href="/Concepts/Building.html" class="nav-list-link">Cosmos Tools</a></li><li class="nav-list-item"><a href="/Nodes/el/nodes.html" class="nav-list-link">Execution Layer Nodes</a></li><li class="nav-list-item"><a href="/Nodes/el/provisioning.html" class="nav-list-link">Execution Provisioing</a></li><li class="nav-list-item"><a href="/Tools/Grafana%2077a16aee0ed046b2a0d38896117bae4f.html" class="nav-list-link">Grafana</a></li><li class="nav-list-item"><a href="/Concepts/HSM.html" class="nav-list-link">HSM for Signing</a></li><li class="nav-list-item"><a href="/Concepts/Validator%20High%20Availability.html" class="nav-list-link">High Availability</a></li><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/Concepts/Key%20Management.html" class="nav-list-link">Key Management</a></li><li class="nav-list-item"><a href="/Concepts/Linux%20Config.html" class="nav-list-link">Linux Configuration</a></li><li class="nav-list-item"><a href="/Concepts/Monitoring.html" class="nav-list-link">Monitoring</a></li><li class="nav-list-item"><a href="/Tools/Nix%207784f9d6cc4e4d22b641606d10105fc4.html" class="nav-list-link">Nix</a></li><li class="nav-list-item"><a href="/Concepts/Peers.html" class="nav-list-link">Peers</a></li><li class="nav-list-item"><a href="/Concepts/Security%20Engineering.html" class="nav-list-link">Security Engineering</a></li><li class="nav-list-item"><a href="/Tools/Systemd%2052d24727df354933a92435c35b657813.html" class="nav-list-link">Systemd</a></li><li class="nav-list-item active"><a href="/Concepts/Systems%20Design.html" class="nav-list-link active">Systems Design</a></li><li class="nav-list-item"><a href="/Tools/Tailscale%20db8b7f2df4aa4d2e81cf9137b3ea7dfe.html" class="nav-list-link">Tailscale</a></li><li class="nav-list-item"><a href="/Tools/Blog%20Posts.html" class="nav-list-link">Technical Knowledge Blogs</a></li><li class="nav-list-item"><a href="/Tools/Terraform%205bdc9ddd7b2342e6b67b83d866006fd6.html" class="nav-list-link">Terraform</a></li><li class="nav-list-item"><a href="/Concepts/Testing.html" class="nav-list-link">Testing</a></li><li class="nav-list-item"><a href="/Concepts/Validator%20Operations%20Guide.html" class="nav-list-link">Validator Operations</a></li><li class="nav-list-item"><a href="/Concepts/Values.html" class="nav-list-link">Values</a></li><li class="nav-list-item"><a href="/Tools/Vault%20fd5dd827a9de4245937760f75b9a6baa.html" class="nav-list-link">Vault</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Infrastructure Knowledge Base" aria-label="Search Infrastructure Knowledge Base" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 id="systems-design"> <a href="#systems-design" class="anchor-heading" aria-labelledby="systems-design"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Systems Design<a href="#systems-design" title="Permalink to this headline"></a> </h1> <p>The key to building and maintaining highly secure and reliable systems is <strong>simplicity</strong> - a good system will have nothing to take away, rather than nothing to add.</p> <p>Each component you use you will have to secure, update and debug forever. Like open source projects which reject code not because it’s bad, but because they don’t have sufficient capacaties to maintain it, you need to be very careful about each piece of technology you introduce into your stack and carefully weight its benefits against the extra complexity it introduces.</p> <p>Debugging and securing a system is an order of magnitude more complicated than building it. There’s a common saying that if you build the most clever system you can think of, you’re by definition unqualified to maintain it - and there’s a lot of truth to it.</p> <h2 id="why-not-kubernetes"> <a href="#why-not-kubernetes" class="anchor-heading" aria-labelledby="why-not-kubernetes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Why not Kubernetes?<a href="#why-not-kubernetes" title="Permalink to this headline"></a> </h2> <p>We’ve heard about many validators who plan to use Kubernetes for their production setups.</p> <p>We strongly recommend against the use of Kubernetes and similar technologies for your core validator operations - they solve problems validator operators don’t have. Validator core infrastructure are <strong>pets, not cattle</strong>. You can’t just deploy a cloud instance, you need to rent dedicated servers and plug HSMs into them. Even if you’re running an active-active setup like ours which tolerates full node outages, you’re unlikely to gain enough from Kubernetes to justify its costs. We recommend traditional configuration management tools like Ansible.</p> <p>Even plain Docker usage should be carefully evaluated - while Docker itself is quite stable, even in 2018, the overlay filesystems and namespacing technology it uses haven’t stabilized yet (not for lack of trying, but any complicated piece of code in the kernel needs decades to mature; people are still finding bugs in ext4 to this day). Any large-scale production user of either Docker and Kubernetes will have tales of Docker daemon crashes in production, weird kernel issues that required node reboots and scheduler bugs that required them to read the Kubernetes source code at 3am in the morning. This is perfectly fine for the kind of stateless infrastructure Docker and Kubernetes are designed for - they are built to tolerate single node losses, or build systems. In fact, many production deployments can auto-update and reboot cluster nodes (like CoreOS/Container Linux does).</p> <p>However, none of this applies to core validator infrastructure. cosmos-sdk compiles to a <em>single binary</em>, you don’t need Docker to deploy it (it’s quite useful for building it, though). You’re not going to need to scale your validator setup up and down across a fleet of thousands of machines. Being able to list all processes running on your nodes and knowing exactly what they’re doing is beautiful, and while it’s certainly possible with Kubernetes, it’s a lot easier with with a stripped-down, hardened node running nothing but your validator software.</p> <p>Advanced security setups like eBPF seccomp policies, auditing, SELinux policies and just plain debugging get a lot easier when there are no kernel namespaces, Docker daemons, runC wrappers and overlay filesystems to reason about.</p> <p>Both Docker and Kubernetes also add a lot of unnecessary attack surface (properly securing Kubernetes alone is pretty complicated - it’s a REST API which hands out omnipotent tokens which have root access to your nodes - that’s the opposite of <em>defense in depth</em>!).</p> <p>Certus One has extensive experience using Docker, Kubernetes and Red Hat’s OpenShift k8s distribution in production and we’re confident that we could pull it off, just like we have no doubt that other teams will. However, we believe that a better result can be achieved without, with time better spent on security hardening and tooling.</p> <p>That being said, we <em>do</em> use Kubernetes for our auxiliary infrastructure like our monitoring stack, continous integration, testing setup and various other internal infrastructure needs. It’s perfect for that - our monitoring stack in particular consists of many small services talking to each other, and Kubernetes is perfect for that. We just don’t want it anywhere where its failure would affect the core of our business - running secure validators.</p> <h2 id="network-topology"> <a href="#network-topology" class="anchor-heading" aria-labelledby="network-topology"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Network topology<a href="#network-topology" title="Permalink to this headline"></a> </h2> <p>We recommend a <strong>flat network</strong> topology where each node has its own unique IP address, with full end-to-end connectivity (only hindered by your firewall rules).</p> <p>You should prefer a fully routed <strong>L3 topology</strong> over switched L2 topologies, especially those of the “magic SDN” variety which use a separate control plane (like OpenVSwitch, ZeroTier and most datacenter SDN technologies in general).</p> <p>L2 topologies have no advantage over L3 routing for applications that have no special networking requirements. Their main users are service providers which need to span L2 network across their data centers to provide their customers with virtual networks. For everyone else, L3 networks are the better choice. L2 networks are brittle, hard to segment (they’re basically one large failure domain), and hard to debug.</p> <p>L3 networks are built to scale, have well-defined interfaces and control plane protocols, and great troubleshooting tools (routing tables, traceroutes and BGP are more intuitive than an opaque SDN control plane which pretends to be a gigantic flat L2 network, but isn’t). The potential blast radius in a L3 network is much smaller than in a L2 network, where a stray spanning-tree packet can potentially take down an entire network.</p> <p>For example, a GCE VPC is completely routed. Each virtual machine has its own transfer network with the VPC router, and the only broadcast packet you’ll ever see are the ones sent by either the router, or the instance. The VPC router maintains a /32 route for each VMs IP addresses. This is why you can’t set next hop routes in your virtual machines, but need to add them in the VPCs routing table - while it pretends to be a large /24 network, it’s in fact a routed network where each instance has its own little network.</p> <p>Via VPC peerings, you can connect multiple networks to their respective IP ranges, which is “just” another entry in the VPC routing table pointing to the other VPC’s router.</p> <p>Network address translation is best avoided. It adds an extra layer of complexity, makes it harder to attribute traffic once it left a NAT boundary and is another state machine on top of TCP and Tendermint’s consensus protocols.</p> <p>It creates all sorts of operational headaches - you need to maintain a separate list of public/private IPs and port forwardings, you can’t easily whitelist traffic from single nodes once it crossed a NAT boundary (you would need to log NAT source ports), and so on.</p> <p><strong>NAT is not a security tool</strong>, firewalls are. You can achieve the same level of network isolation with and without NAT. It’s hard to avoid - most cloud provider’s VPC networks use RFC 1918 addresses internally with NAT for external connectivity, and you need <em>some</em> sort of NAT at the network edges - but you should keep its use to a minimum and ensure that nodes can communicate without NAT inside of your network.</p> <p>Kubernetes is another good example - each pod has its own IP address in a large flat network, which can be either routed or switched, depending on the network plugin you use - <a href="https://www.projectcalico.org/">Calico</a> is what we use. Each pod can talk to each other across this flat network as long as the network policy allows it. However, pods need to talk to the outside world sometimes, so each node does outgoing NAT for the traffic originating from pods running on it. The outside world also needs to talk to some of the services running in the cluster, so there’s a load balancer which accepts traffic on its public IP address and load balances it to the internal IPs.</p> <h2 id="secret-management"> <a href="#secret-management" class="anchor-heading" aria-labelledby="secret-management"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Secret management<a href="#secret-management" title="Permalink to this headline"></a> </h2> <p><strong>Avoid working with secrets</strong>, especially bearer tokens, <em>especially</em> if they can be used on public APIs without any additional layer of security (looking at you, public cloud platforms and k8s).</p> <p>Use service-level certificate-based authentication to authenticate your services against a centralized secrets storage like <a href="https://www.vaultproject.io/">Hashicorp Vault</a>.</p> <p>If possible, use Vault’s auto-provisioning feature which creates individual short-lived credentials for each service.</p> <p>If you use stateless tokens like JWT, make sure to hardcode the signature algorithm and either use very short-lived tokens that expire after a few minutes, with stateful refresh tokens that you can invalidate, or another invalidation mechanism like revocation lists or a mechanism that invalidates all tokens issued before a certain timestamp (for emergencies).</p> <p>Red Hat IDP/<a href="https://www.keycloak.org/">Keycloak</a> is a good OAuth/JWT server which implements both short-lived tokens as well as not-before timestamps.</p> <p>If you have a lot of services that need to authenticate at each other, you might reach a point where a service mesh like <a href="https://istio.io/">Istio</a> is worth looking into.</p> <hr> <footer> <div class="d-flex mt-2"> <p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/just-the-docs/just-the-docs/tree/main/Concepts/Systems Design.md" id="edit-this-page">Edit this page on GitHub.</a> </p> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
